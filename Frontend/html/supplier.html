<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../css/supplier.css" />
  <title>Supplier Management</title>
</head>
<body>

  <aside class="sidebar">
    <h2>IMS</h2>
    <nav>
      <a href="category.html" class="nav-link" id="link-category">Category</a>
      <a href="inventory.html" class="nav-link" id="link-inventory">Inventory</a>
      <a href="profile.html" class="nav-link" id="link-profile">Profile</a>
      <a href="supplier.html" class="nav-link active" id="link-supplier">Supplier</a>
      <a href="transaction.html" class="nav-link" id="link-transaction">Transaction</a>
      <a href="login.html" class="nav-link" style="margin-top: auto; color: #ff6b6b;">Logout</a>
    </nav>
  </aside>

  <main class="content">
    <h1>Supplier Management</h1>

    <!-- Add New Supplier -->
    <section>
      <h2>Add New Supplier</h2>
      <form id="supplier-form">
        <input type="text" id="supplier-name" placeholder="Supplier Name" required />
        <button type="submit">Add Supplier</button>
      </form>
    </section>

    <!-- Supplier List -->
    <section style="margin-top: 30px;">
      <h2>Suppliers</h2>
      <table>
        <thead>
          <tr><th>Name</th><th>Actions</th></tr>
        </thead>
        <tbody id="supplier-tbody">
          <tr><td colspan="2" class="no-data">Loading suppliers...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

<script>
  async function loadSuppliers() {
    try {
      const res = await fetch('http://localhost:3000/api/suppliers');
      if (!res.ok) throw new Error('Failed to load suppliers');
      const data = await res.json();
      const suppliers = data.data || [];

      const tbody = document.getElementById('supplier-tbody');
      tbody.innerHTML = '';
      if (suppliers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="no-data">No suppliers found.</td></tr>';
        return;
      }

      suppliers.forEach(supplier => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" value="${supplier.name}" data-id="${supplier.id}" class="edit-name" /></td>
          <td>
            <button class="update-btn" data-id="${supplier.id}">Update</button>
            <button class="delete-btn" data-id="${supplier.id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      alert(err.message);
    }
  }

  // Add supplier
  document.getElementById('supplier-form').addEventListener('submit', async e => {
    e.preventDefault();
    const nameInput = document.getElementById('supplier-name');
    const name = nameInput.value.trim();
    if (!name) return alert('Supplier name is required');

    try {
      const res = await fetch('http://localhost:3000/api/suppliers', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name })
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.message || 'Failed to add supplier');
      }
      alert('Supplier added successfully');
      nameInput.value = '';
      await loadSuppliers();
    } catch (err) {
      alert(err.message);
    }
  });

  // Handle update and delete buttons via event delegation
  document.getElementById('supplier-tbody').addEventListener('click', async e => {
    if (e.target.classList.contains('update-btn')) {
      const id = e.target.dataset.id;
      const input = e.target.closest('tr').querySelector('.edit-name');
      const newName = input.value.trim();
      if (!newName) return alert('Supplier name cannot be empty');

      try {
        const res = await fetch('http://localhost:3000/api/suppliers', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ id, name: newName })
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message || 'Failed to update supplier');
        }
        alert('Supplier updated successfully');
        await loadSuppliers();
      } catch (err) {
        alert(err.message);
      }
    } else if (e.target.classList.contains('delete-btn')) {
      const id = e.target.dataset.id;
      if (!confirm('Are you sure you want to delete this supplier?')) return;

      try {
        const res = await fetch(`http://localhost:3000/api/suppliers/${id}`, {
          method: 'DELETE'
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message || 'Failed to delete supplier');
        }
        alert('Supplier deleted successfully');
        await loadSuppliers();
      } catch (err) {
        alert(err.message);
      }
    }
  });

  // Load suppliers on page load
  loadSuppliers();
</script>
</body>
</html>
